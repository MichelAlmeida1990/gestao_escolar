{% extends 'base.html' %}

{% block title %}{{ titulo }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>{{ titulo }}</h1>
        <a href="{% url 'alunos:aluno_list' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Voltar
        </a>
    </div>
    
    <div class="card">
        <div class="card-body">
            <form method="post" enctype="multipart/form-data" novalidate>
                {% csrf_token %}
                
                <div class="row">
                    <div class="col-12">
                        <h4 class="mb-3">Informações Básicas</h4>
                        <hr>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.nome.id_for_label }}" class="form-label">{{ form.nome.label }}</label>
                        {{ form.nome }}
                        {% if form.nome.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.nome.errors }}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <label for="{{ form.data_nascimento.id_for_label }}" class="form-label">{{ form.data_nascimento.label }}</label>
                        {{ form.data_nascimento }}
                        {% if form.data_nascimento.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.data_nascimento.errors }}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <label for="{{ form.matricula.id_for_label }}" class="form-label">{{ form.matricula.label }}</label>
                        {{ form.matricula }}
                        {% if form.matricula.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.matricula.errors }}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <label for="{{ form.cpf.id_for_label }}" class="form-label">{{ form.cpf.label }}</label>
                        {{ form.cpf }}
                        {% if form.cpf.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.cpf.errors }}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <label for="{{ form.rg.id_for_label }}" class="form-label">{{ form.rg.label }}</label>
                        {{ form.rg }}
                        {% if form.rg.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.rg.errors }}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <label for="{{ form.data_ingresso.id_for_label }}" class="form-label">{{ form.data_ingresso.label }}</label>
                        {{ form.data_ingresso }}
                        {% if form.data_ingresso.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.data_ingresso.errors }}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <label for="{{ form.status.id_for_label }}" class="form-label">{{ form.status.label }}</label>
                        {{ form.status }}
                        {% if form.status.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.status.errors }}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="col-12">
                        <h4 class="mt-4 mb-3">Contato</h4>
                        <hr>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.telefone.id_for_label }}" class="form-label">{{ form.telefone.label }}</label>
                        {{ form.telefone }}
                        {% if form.telefone.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.telefone.errors }}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.email.id_for_label }}" class="form-label">{{ form.email.label }}</label>
                        {{ form.email }}
                        {% if form.email.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.email.errors }}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="col-12">
                        <h4 class="mt-4 mb-3">Endereço</h4>
                        <hr>
                    </div>
                    
                    <div class="col-md-12 mb-3">
                        <label for="{{ form.endereco.id_for_label }}" class="form-label">{{ form.endereco.label }}</label>
                        {{ form.endereco }}
                        {% if form.endereco.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.endereco.errors }}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <label for="{{ form.bairro.id_for_label }}" class="form-label">{{ form.bairro.label }}</label>
                        {{ form.bairro }}
                        {% if form.bairro.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.bairro.errors }}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <label for="{{ form.cidade.id_for_label }}" class="form-label">{{ form.cidade.label }}</label>
                        {{ form.cidade }}
                        {% if form.cidade.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.cidade.errors }}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="col-md-2 mb-3">
                        <label for="{{ form.estado.id_for_label }}" class="form-label">{{ form.estado.label }}</label>
                        {{ form.estado }}
                        {% if form.estado.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.estado.errors }}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="col-md-2 mb-3">
                        <label for="{{ form.cep.id_for_label }}" class="form-label">{{ form.cep.label }}</label>
                        {{ form.cep }}
                        {% if form.cep.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.cep.errors }}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="col-12">
                        <h4 class="mt-4 mb-3">Responsável</h4>
                        <hr>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.responsavel_nome.id_for_label }}" class="form-label">{{ form.responsavel_nome.label }}</label>
                        {{ form.responsavel_nome }}
                        {% if form.responsavel_nome.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.responsavel_nome.errors }}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.responsavel_telefone.id_for_label }}" class="form-label">{{ form.responsavel_telefone.label }}</label>
                        {{ form.responsavel_telefone }}
                        {% if form.responsavel_telefone.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.responsavel_telefone.errors }}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="col-12">
                        <h4 class="mt-4 mb-3">Foto e Observações</h4>
                        <hr>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.foto.id_for_label }}" class="form-label">{{ form.foto.label }}</label>
                        <div class="d-flex align-items-start">
                            <div class="me-3">
                                <div id="foto-preview" class="border rounded p-2 text-center" style="width: 120px; height: 120px; display: flex; align-items: center; justify-content: center; background-color: #f8f9fa;">
                                    {% if form.instance.foto %}
                                        <img src="{{ form.instance.foto.url }}" alt="Foto do aluno" class="img-fluid rounded" style="max-width: 100%; max-height: 100%; object-fit: cover;">
                                    {% else %}
                                        <div class="text-muted">
                                            <i class="fas fa-camera fa-2x mb-2"></i>
                                            <br>
                                            <small>Sem foto</small>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="flex-grow-1">
                                {{ form.foto }}
                                {% if form.foto.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.foto.errors }}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    <i class="fas fa-info-circle"></i> 
                                    Formatos aceitos: JPG, PNG, GIF. Tamanho máximo: 5MB.
                                </div>
                                {% if form.instance.foto %}
                                    <div class="mt-2">
                                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerFoto()">
                                            <i class="fas fa-trash"></i> Remover Foto
                                        </button>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.observacoes.id_for_label }}" class="form-label">{{ form.observacoes.label }}</label>
                        {{ form.observacoes }}
                        {% if form.observacoes.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.observacoes.errors }}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="col-12 mt-4">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> {{ botao }}
                        </button>
                        <a href="{% url 'alunos:aluno_list' %}" class="btn btn-secondary">
                            <i class="fas fa-times"></i> Cancelar
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Preview da foto selecionada com validação
document.getElementById('{{ form.foto.id_for_label }}').addEventListener('change', function(e) {
    const file = e.target.files[0];
    const preview = document.getElementById('foto-preview');
    
    if (file) {
        // Validar tamanho do arquivo (5MB)
        const maxSize = 5 * 1024 * 1024; // 5MB em bytes
        if (file.size > maxSize) {
            alert('Arquivo muito grande! Tamanho máximo permitido: 5MB.');
            this.value = '';
            return;
        }
        
        // Validar tipo de arquivo
        if (!file.type.startsWith('image/')) {
            alert('Por favor, selecione apenas arquivos de imagem (JPG, PNG, GIF).');
            this.value = '';
            return;
        }
        
        // Mostrar preview
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.innerHTML = '<img src="' + e.target.result + '" alt="Preview" class="img-fluid rounded" style="max-width: 100%; max-height: 100%; object-fit: cover;">';
        };
        reader.readAsDataURL(file);
        
        // Mostrar informações do arquivo
        const fileInfo = document.createElement('div');
        fileInfo.className = 'mt-2 text-muted small';
        fileInfo.innerHTML = `
            <i class="fas fa-info-circle"></i> 
            ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)
        `;
        preview.parentElement.appendChild(fileInfo);
    }
});

// Função para remover foto
function removerFoto() {
    if (confirm('Tem certeza que deseja remover a foto?')) {
        const preview = document.getElementById('foto-preview');
        const input = document.getElementById('{{ form.foto.id_for_label }}');
        
        preview.innerHTML = '<div class="text-muted"><i class="fas fa-camera fa-2x mb-2"></i><br><small>Sem foto</small></div>';
        input.value = '';
        
        // Remover informações do arquivo se existirem
        const fileInfo = preview.parentElement.querySelector('.text-muted.small');
        if (fileInfo) {
            fileInfo.remove();
        }
        
        // Esconder o botão de remover
        const removeBtn = document.querySelector('button[onclick="removerFoto()"]');
        if (removeBtn && removeBtn.parentElement) {
            removeBtn.parentElement.style.display = 'none';
        }
    }
}

// Drag and drop para upload de foto
const fotoInput = document.getElementById('{{ form.foto.id_for_label }}');
const fotoPreview = document.getElementById('foto-preview');

fotoPreview.addEventListener('dragover', function(e) {
    e.preventDefault();
    e.stopPropagation();
    this.style.borderColor = '#007bff';
    this.style.backgroundColor = '#e3f2fd';
    this.style.cursor = 'copy';
});

fotoPreview.addEventListener('dragleave', function(e) {
    e.preventDefault();
    e.stopPropagation();
    this.style.borderColor = '#dee2e6';
    this.style.backgroundColor = '#f8f9fa';
    this.style.cursor = 'pointer';
});

fotoPreview.addEventListener('drop', function(e) {
    e.preventDefault();
    e.stopPropagation();
    this.style.borderColor = '#dee2e6';
    this.style.backgroundColor = '#f8f9fa';
    this.style.cursor = 'pointer';
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        const file = files[0];
        
        // Validar tipo de arquivo
        if (file.type.startsWith('image/')) {
            // Validar tamanho
            const maxSize = 5 * 1024 * 1024; // 5MB
            if (file.size > maxSize) {
                alert('Arquivo muito grande! Tamanho máximo permitido: 5MB.');
                return;
            }
            
            // Criar um DataTransfer para simular a seleção do arquivo
            const dt = new DataTransfer();
            dt.items.add(file);
            fotoInput.files = dt.files;
            
            // Disparar evento change para atualizar o preview
            fotoInput.dispatchEvent(new Event('change', { bubbles: true }));
        } else {
            alert('Por favor, solte apenas arquivos de imagem (JPG, PNG, GIF).');
        }
    }
});

fotoPreview.addEventListener('click', function() {
    fotoInput.click();
});

// Adicionar estilo de cursor pointer ao preview
fotoPreview.style.cursor = 'pointer';

// Mostrar dica visual quando houver hover
fotoPreview.addEventListener('mouseenter', function() {
    if (!this.querySelector('img')) {
        this.style.backgroundColor = '#f0f0f0';
    }
});

fotoPreview.addEventListener('mouseleave', function() {
    if (!this.querySelector('img')) {
        this.style.backgroundColor = '#f8f9fa';
    }
});

// Validação antes do envio do formulário
document.querySelector('form').addEventListener('submit', function(e) {
    const fotoInput = document.getElementById('{{ form.foto.id_for_label }}');
    const file = fotoInput.files[0];
    
    if (file) {
        // Validação final antes do envio
        const maxSize = 5 * 1024 * 1024; // 5MB
        if (file.size > maxSize) {
            e.preventDefault();
            alert('Erro: Arquivo muito grande! Tamanho máximo permitido: 5MB.');
            return false;
        }
        
        if (!file.type.startsWith('image/')) {
            e.preventDefault();
            alert('Erro: Por favor, envie apenas arquivos de imagem.');
            return false;
        }
    }
});
</script>
{% endblock %}
